# Ensure trailing slash
# if ($uri !~ /$) { return 301 $uri/; }

location ^~ /code-executor {
    if ($uri !~ /$) { return 301 $uri/; }
    location ~ ^/code-executor(?<suffix>/.*)?$ {
        rewrite ^ /${suffix} break;
        include /etc/nginx/snippets/cors.conf;
        proxy_set_header X-Target-Service code-executor;
        proxy_set_header X-Target-Port 8000;
        proxy_pass http://lazy-manager:8001;
    }
}

location ^~ /deno-test {
    if ($uri !~ /$) { return 301 $uri/; }
    location ~ ^/deno-test(?<suffix>/.*)?$ {
        rewrite ^ /${suffix} break;
        proxy_set_header X-Target-Service deno-test;
        proxy_set_header X-Target-Port 8000;
        proxy_pass http://lazy-manager:8001;
    }
}

location ^~ /python-go-test {
    if ($uri !~ /$) { return 301 $uri/; }
    location ~ ^/python-go-test(?<suffix>/.*)?$ {
        rewrite ^ /${suffix} break;
        proxy_set_header X-Target-Service python-go-test;
        proxy_set_header X-Target-Port 8000;
        proxy_pass http://lazy-manager:8001;
    }
}

# Static sites with trailing slash enforcement
location ~ ^/(?<app>[^/]+)$ {
    return 301 /$app/;
}

location ~ ^/(?<app>[^/]+)/ {
    root /var/www/html;
    index index.html;
    try_files $uri $uri/ /$app/index.html =404;
}

# Example: Completely disable rate limiting for a specific route
# location /unlimited-api {
#     limit_req off;
#     proxy_pass http://some-service;
# }

# Example: Use a different rate
# Note: rate is defined in the zone in default.conf
# location /my-api {
#     limit_req zone=api_limit_fast burst=10 nodelay;
#     proxy_pass http://some-service;
# }

# Example: Non lazy app
# location ^~ /my-non-lazy-app {
#     rewrite ^/my-non-lazy-app$ /my-non-lazy-app/ permanent;
#     rewrite ^/my-non-lazy-app/(.*) /$1 break;
#     proxy_pass http://my-non-lazy-app:8000;
# }