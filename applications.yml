services:
    python-go-test:
        build: ./services/python/python-go-test
        profiles:
            - lazy
        labels:
            - "lazy=true"
        expose:
            - "8000"
        environment:
            DB_HOST: python-app-db
            DB_USER: ${APP_PYTHON_APP_DB_USER}
            DB_PASSWORD: ${APP_PYTHON_APP_DB_PASSWORD}
            DB_NAME: ${APP_PYTHON_APP_DB_NAME}
        depends_on:
            - python-app-db
            - go-worker
        restart: on-failure

    python-app-db:
        image: postgres:17-alpine
        environment:
            POSTGRES_DB: ${APP_PYTHON_APP_DB_NAME}
            POSTGRES_USER: ${APP_PYTHON_APP_DB_USER}
            POSTGRES_PASSWORD: ${APP_PYTHON_APP_DB_PASSWORD}
        profiles:
            - lazy
        labels:
            - "lazy=true"
        volumes:
            - postgres_data:/var/lib/postgresql/data
        restart: unless-stopped

    go-worker:
        build: ./services/go/go-worker
        profiles:
            - lazy
        labels:
            - "lazy=true"
        expose:
            - "8080"
        restart: on-failure

    deno-test:
        build: ./services/deno/deno-test
        profiles:
            - lazy
        labels:
            - "lazy=true"
        expose:
            - "8000"
        restart: on-failure

    code-executor:
        runtime: runsc
        build: ./services/deno/code-executor
        profiles:
            - lazy
        labels:
            - "lazy=true"
        working_dir: /workspace
        tmpfs:
            - /workspace:size=32M,mode=1777,nr_inodes=100
            - /tmp:size=32M,mode=1777,nr_inodes=100
        security_opt:
            - no-new-privileges:true
        cap_drop:
            - ALL
        expose:
            - "8000"
        restart: on-failure
        deploy:
            resources:
                limits:
                    cpus: "0.5"
                    memory: 256M
                    pids: 50
